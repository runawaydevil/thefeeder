{% extends "base.html" %}

{% macro pagination_url(page) -%}
?page={{ page }}{% if current_feed_id %}&feed_id={{ current_feed_id }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by and sort_by != 'recent' %}&sort={{ sort_by }}{% endif %}
{%- endmacro %}

{% block content %}
<div class="stats">
    <p class="small">
        {% if search_query %}
        {{ total_items }} result{{ 's' if total_items != 1 else '' }} for "{{ search_query }}" • Page {{ current_page }} of {{ total_pages }}
        {% else %}
        {{ total_items }} articles • Page {{ current_page }} of {{ total_pages }}
        {% endif %}
    </p>
</div>

<form method="get" class="filters">
    <label>
        Search:
        <input type="search" name="search" value="{{ search_query or '' }}" placeholder="Search articles..." class="search-input">
    </label>
    
    <label>
        Feed:
        <select name="feed_id" onchange="this.form.submit()">
            <option value="">All feeds</option>
            {% for feed in feeds %}
            <option value="{{ feed.id }}" {{ 'selected' if feed.id == current_feed_id else '' }}>
                {{ feed.name }}
            </option>
            {% endfor %}
        </select>
    </label>
    
    <label>
        Sort:
        <select name="sort" onchange="this.form.submit()">
            <option value="recent" {{ 'selected' if sort_by == 'recent' else '' }}>Most recent</option>
            <option value="oldest" {{ 'selected' if sort_by == 'oldest' else '' }}>Oldest</option>
            <option value="title" {{ 'selected' if sort_by == 'title' else '' }}>Title (A-Z)</option>
            <option value="feed" {{ 'selected' if sort_by == 'feed' else '' }}>By feed</option>
        </select>
    </label>
    
    {% if current_feed_id or search_query or (sort_by and sort_by != 'recent') %}
    <a href="/" class="btn">Clear filters</a>
    {% endif %}
</form>

{% if articles %}
<ul class="list">
    {% for article in articles %}
    <li class="card" data-article-id="{{ article.id }}">
        <h3><a href="{{ article.link }}" target="_blank" rel="noopener">{{ article.title }}</a></h3>
        
        <div class="meta">
            <span class="feed">
                {{ article.feed_name }}
                {% if feed_statuses and feed_statuses.get(article.feed_id) %}
                {% set status = feed_statuses[article.feed_id] %}
                {% if status.status == 'success' %}
                <span class="feed-status feed-status-success" title="Feed working normally">●</span>
                {% elif status.status == 'error' %}
                <span class="feed-status feed-status-error" title="Error updating feed">●</span>
                {% elif status.status == 'not_modified' %}
                <span class="feed-status feed-status-warning" title="No recent updates">●</span>
                {% else %}
                <span class="feed-status feed-status-pending" title="Waiting for update">●</span>
                {% endif %}
                {% endif %}
            </span>
            {% if article.published %}
            <span class="date" data-timeago="{{ article.published.isoformat() }}" data-full-date="{{ article.published.strftime('%d/%m/%Y às %H:%M') }}">{{ article.published.strftime('%d/%m/%Y %H:%M') }}</span>
            {% endif %}
            {% if article.author %}
            <span class="author">{{ article.author }}</span>
            {% endif %}
        </div>
        
        {% if article.summary %}
        <div class="summary">{{ article.summary[:200] }}{% if article.summary|length > 200 %}...{% endif %}</div>
        {% endif %}
        
        {% if article.thumbnail %}
        <div class="thumbnail">
            <img src="{{ article.thumbnail }}" alt="Thumbnail" loading="lazy" class="loading" onload="this.classList.remove('loading'); this.classList.add('loaded');" onerror="this.classList.remove('loading'); this.classList.add('error');">
        </div>
        {% endif %}
    </li>
    {% endfor %}
</ul>

{% if total_pages > 1 %}
<nav class="pager" aria-label="Pagination">
    <div class="pager-nav">
        {% if prev_page %}
        <a href="{{ pagination_url(prev_page) }}" class="pager-btn" aria-label="Go to previous page">
            <span>←</span> <span>Previous</span>
        </a>
        {% else %}
        <span class="pager-btn" disabled aria-disabled="true">
            <span>←</span> <span>Previous</span>
        </span>
        {% endif %}
    </div>
    
    <div class="page-numbers">
        {% if page_numbers[0] > 1 %}
        <a href="{{ pagination_url(1) }}" class="page-number" aria-label="Go to page 1">1</a>
        {% if page_numbers[0] > 2 %}
        <span class="page-number ellipsis" aria-hidden="true">...</span>
        {% endif %}
        {% endif %}
        
        {% for page_num in page_numbers %}
        {% if page_num == current_page %}
        <span class="page-number current" aria-current="page" aria-label="Current page, page {{ page_num }}">{{ page_num }}</span>
        {% else %}
        <a href="{{ pagination_url(page_num) }}" class="page-number" aria-label="Go to page {{ page_num }}">
            {{ page_num }}
        </a>
        {% endif %}
        {% endfor %}
        
        {% if page_numbers[-1] < total_pages %}
        {% if page_numbers[-1] < total_pages - 1 %}
        <span class="page-number ellipsis" aria-hidden="true">...</span>
        {% endif %}
        <a href="{{ pagination_url(total_pages) }}" class="page-number" aria-label="Go to page {{ total_pages }}">{{ total_pages }}</a>
        {% endif %}
    </div>
    
    <div class="pager-nav">
        {% if next_page %}
        <a href="{{ pagination_url(next_page) }}" class="pager-btn" aria-label="Go to next page">
            <span>Next</span> <span>→</span>
        </a>
        {% else %}
        <span class="pager-btn" disabled aria-disabled="true">
            <span>Next</span> <span>→</span>
        </span>
        {% endif %}
    </div>
</nav>
{% endif %}

{% else %}
<div class="empty">
    <h2>No articles found</h2>
    {% if current_feed_id %}
    <p>No articles in this feed yet. Articles will appear here when the feed is updated.</p>
    <div class="empty-actions">
        <a href="/" class="btn">View all feeds</a>
        <a href="/admin/refresh?feed_id={{ current_feed_id }}" class="btn secondary">Refresh feed</a>
    </div>
    {% else %}
    <p>No articles available at the moment. Check if feeds are being updated correctly.</p>
    <div class="empty-actions">
        <a href="/admin/health" class="btn">View feed status</a>
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}


